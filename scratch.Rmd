---
title: "EDA"
author: "Paul Villanueva"
date: "5/1/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(data.table)
library(doParallel)
library(dplyr)
library(ggplot2)
library(igraph)
library(reshape2)
library(scales)
library(tidyverse)
library(GENIE3)

theme_set(theme_light())
```

# Helper functions



```{r}
bootstrap_cor <- function(dat.observed, B = 1000) {
  
  library(data.table)

  # dat.observed = proteomics.expr
  
  n <- ncol(dat.observed)
  
  boots = data.table(c_score = numeric(), counts = numeric())
    
    
    
  for (i in 1:B){
  dat.perm <- data.table(dat.observed[, sample(n, n, replace = TRUE)])
  
  cor.perm <- data.table(c(round(cor(dat.perm), 3)))
  cor.perm[, counts := .N, by = .(V1)]
  cor.perm <- unique(cor.perm)
  
  boots <- rbindlist(list(boots, cor.perm))[, lapply(.SD, sum, na.rm = TRUE), 
                                            by = .(c_score)]

  }

  boots <- boots %>% arrange(-c_score) %>% data.table()

  return(boots)
}
```

```{r}
bootstrap_quantiles <- function(boots) {
  boots[, prop := counts/sum(counts)]
  
  quantiles <- boots[, list(
    upper = c_score[sum(cumsum(prop) <= 0.025)],
    lower = c_score[sum(cumsum(prop) <= 0.975)]
  )]
  
  return(quantiles)
}
```

```{r}
threshold_cor_matrix <- function(cor.matrix, quantiles){
  
  cor.matrix[cor.matrix > proteomics.quantiles$upper] <- 1
  cor.matrix[cor.matrix < proteomics.quantiles$lower] <- -1
  cor.matrix[cor.matrix < proteomics.quantiles$upper & cor.matrix > proteomics.quantiles$lower] <- 0
  
  return(cor.matrix)

}
```


# Metabolomics data

```{r}
metabolomics <- read.delim("./data/raw/Metabolomics2.txt")
```

# Proteomics

```{r}
proteomics <- read.delim("./data/raw/Proteomics2.txt")
```


## Calculating correlations.

```{r}
proteomics.expr <- proteomics %>% 
  column_to_rownames(var = "UNIQID") %>% 
  select(7:12) %>% 
  t()
```

```{r}
proteomics.cor <- cor(proteomics.expr)
```

Visualization:

```{r}
ggplot(melt(proteomics.cor), aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  coord_equal() +
  labs(x = "", y = "", title = "Protein-protein interactions",
       subtitle = "Measured by Pearson correlation") + 
  scale_fill_gradient2(low = "red", mid = "black", high = "steelblue") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 2),
        axis.text.y = element_text(size = 2))
```



```{r}
proteomics.expr.boots <- bootstrap_cor(proteomics.expr, B = 20)
proteomics.quantiles <- bootstrap_quantiles(proteomics.expr.boots)
```



```{r}
ggplot(proteomics.expr.boots, aes(x = c_score, y = counts)) + 
  geom_col() + 
  scale_y_continuous(limits = c(0, max(proteomics.expr.boots$counts))) + 
  labs(x = "Pearson correlation", y = "Counts",
       title = "Simulated correlation values",
       subtitle = "2.5% thresholds indicated") +
  geom_vline(xintercept = c(proteomics.quantiles$lower, proteomics.quantiles$upper), color = "#BB0000", linetype = 'dashed')
```
 

Updated heatmap showing only the significant correlations

```{r}
t <- threshold_cor_matrix(proteomics.cor, quantiles)
ggplot(melt(t), aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  coord_equal() +
  labs(x = "", y = "", title = "Significant protein-protein interactions",
       subtitle = "Measured by Pearson correlation") + 
  scale_fill_gradient2(low = "red", mid = "black", high = "steelblue") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 2),
        axis.text.y = element_text(size = 2),
        axis.ticks = element_blank())
```



#  Transcriptomics

```{r}
transcriptomics <- read.delim("./data/raw/Transcriptomics2.txt")
```

### Building GRN

I ran GENIE3 several times for different combinations of samples:

1. PHOTOTROPH1 - PHOTOTROPH3
2. H1 - H3
3. L1 - L3
4. H1 - H3, L1 - L3
5. PHOTOTROPH1 - PHOTOTROPH3, H1 - H3, L1 - L3

I saved the resulting matrices in (unzipped) data/grn_mats/transcriptomics. The name corresponds to the columns I considered. You can read them in with:

```{r}
H1_H2_H3.distmat <- readRDS("./data/grn_mats/transcriptomics/t_H1-H2-H3.rds")
```

And from there, you can make a network by doing:

```{r}
H1_H2_H3.network <- graph_from_adjacency_matrix(H1_H2_H3.distmat)
```

```{r}
plot(H1_H2_H3.network)
```








